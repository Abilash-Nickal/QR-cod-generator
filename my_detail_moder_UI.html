import io
import base64
import os
import json
import urllib.parse
from flask import Flask, request, render_template_string, send_file
import qrcode
from qrcode.image.pil import PilImage

# --- Flask Application Setup ---
app = Flask(__name__)

# --- Configuration for Minimized QR Code ---
QR_BOX_SIZE = 5 
QR_ERROR_CORRECTION = qrcode.constants.ERROR_CORRECT_L

# Global storage for the last generated QR code data (for download)
last_qr_data = None
saved_input_data = {}

# --- Helper Function for URL Encoding ---

def generate_target_url(data):
    """
    Creates a standardized public URL where the user's data is embedded as query parameters.
    """
    
    # 1. Base URL for the public details page (REPLACE WITH YOUR ACTUAL HOSTED PAGE)
    BASE_DETAIL_PAGE = "https://abilash-nickal.github.io/QR-cod-generator/my_detail_moder_UI.html"

    # 2. Encode the parameters
    params = {}
    if data.get('name'):
        params['name'] = data['name']
    if data.get('message'):
        params['msg'] = data['message']
    
    # --- SMART LINK LOGIC ---
    if data.get('link'):
        params['url'] = data['link']
    
    # Image URL is optional
    if data.get('image_url'):
        params['img'] = data['image_url']
    
    # 3. Construct the query string
    query_string = urllib.parse.urlencode(params)
    
    # 4. Return the full, scannable URL
    return f"{BASE_DETAIL_PAGE}?{query_string}"

# --- HTML Template (The Input and Output UI) ---
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced QR Code Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .url-box { 
            background-color: #fefcbf; 
            border-left: 4px solid #f97316; 
            padding: 0.75rem; 
            color: #78350f; 
            font-weight: 600; 
            overflow-wrap: break-word;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            QR Code Data Encoder (Minimized Size)
        </h1>
        <p class="text-gray-500 mb-8 text-center">
            Encode social media, direct contact methods, or copyable text instantly.
        </p>

        <!-- QR Code Input Form -->
        <form id="qrForm" method="POST" action="/generate_qr" class="space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Name -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name (Required)</label>
                    <input type="text" id="name" name="name" required placeholder="Your Full Name" 
                           value="{{ saved_data.name or 'Abila' }}"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Message -->
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700">Short Message</label>
                    <input type="text" id="message" name="message" placeholder="A brief greeting or status" 
                           value="{{ saved_data.message or 'Hello from my QR App!' }}"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <!-- SMART LINK CONTROLS -->
            <div class="grid grid-cols-3 gap-4 border p-4 rounded-lg bg-gray-50">
                <div class="col-span-1">
                    <label for="platform" class="block text-sm font-medium text-gray-700">Platform Type</label>
                    <select id="platform" onchange="updateLink()" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- Optional Link --</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="youtube">YouTube</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="whatsapp">WhatsApp (Number)</option>
                        <option value="tel">Phone Call (Number)</option>
                        <option value="sms">Send SMS (Number)</option>
                        <option value="mailto">Send Email (Address)</option>
                        <option value="copy_text">Copy Text/Data</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label for="username" class="block text-sm font-medium text-gray-700" id="usernameLabel">ID / Number / Data</label>
                    <input type="text" id="username" name="username_input" oninput="updateLink()" placeholder="e.g., your-profile-id or Registration Key" 
                           value="{{ saved_data.username or '' }}"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <!-- Hidden field for the final resolved URL -->
            <input type="hidden" name="link" id="finalLink" value="{{ saved_data.link or '' }}">

            <!-- Image URL (OPTIONAL) -->
            <div>
                <label for="image_url" class="block text-sm font-medium text-gray-700">Image URL (Optional Hosted Profile Picture)</label>
                <input type="url" id="image_url" name="image_url" placeholder="Paste link to your online image here" 
                       value="{{ saved_data.image_url or '' }}"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <button
                type="submit"
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out"
            >
                Generate Custom QR Code
            </button>
        </form>

        {% if qr_image %}
        <!-- Output and Preview Section -->
        <div class="mt-10 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">
                Generated Code & Preview
            </h2>

            <div class="url-box p-4 rounded-lg mb-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Encoded Data (Scan Target):</p>
                <code class="block text-xs text-red-600 break-all">{{ display_url }}</code>
            </div>

            <div class="flex justify-center mb-6">
                <img src="data:image/png;base64,{{ qr_image }}" alt="Generated QR Code" class="p-2 border border-gray-300 rounded-lg max-w-full h-auto">
            </div>
            
            <a 
                href="/download_qr"
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out"
            >
                Download QR Code (PNG)
            </a>
        </div>
        {% endif %}
    </div>
    
    <script>
        {% raw %}
        // Mapping of platform key to its base URL/format
        const PLATFORM_BASES = {
            'facebook': 'https://www.facebook.com/',
            'instagram': 'https://www.instagram.com/',
            'youtube': 'https://www.youtube.com/@', 
            'linkedin': 'https://www.linkedin.com/in/',
            'whatsapp': 'https://wa.me/', 
            'tel': 'tel:',         
            'sms': 'sms:',         
            'mailto': 'mailto:',   
            'copy_text': 'COPY:',   // Custom prefix for copy action
            '': '' 
        };

        const LABELS = {
            'facebook': 'Profile ID',
            'instagram': 'Username',
            'youtube': 'Channel ID / @Username',
            'linkedin': 'Profile ID',
            'whatsapp': 'Phone Number (Intl. Format)',
            'tel': 'Phone Number',
            'sms': 'Phone Number',
            'mailto': 'Email Address',
            'copy_text': 'Text/Key to Copy',
            '': 'ID / Number / Data'
        };

        /**
         * Dynamically constructs the full URL and updates the hidden input field.
         */
        function updateLink() {
            const platform = document.getElementById('platform').value;
            const usernameInput = document.getElementById('username');
            const username = usernameInput.value.trim();
            const finalLinkInput = document.getElementById('finalLink');
            const usernameLabel = document.getElementById('usernameLabel');
            
            // 1. Update the label based on platform type
            usernameLabel.innerText = LABELS[platform] || 'ID / Number / Data';
            
            let finalUrl = '';

            if (platform && username) {
                let baseUrl = PLATFORM_BASES[platform];

                if (platform === 'whatsapp' || platform === 'tel' || platform === 'sms') {
                    // For phone numbers, clean them up
                    const cleanNumber = username.replace(/[^0-9+]/g, '');
                    if (cleanNumber) {
                        finalUrl = baseUrl + cleanNumber;
                    }
                } else if (platform === 'youtube') {
                    // Handle YouTube @ symbol
                    const cleanUsername = username.startsWith('@') ? username.substring(1) : username;
                    finalUrl = baseUrl + cleanUsername;
                } else if (platform === 'copy_text') {
                    // Special case: Encode the base URL with the raw text
                    // This is the data the public page will read and copy
                    finalUrl = BASE_DETAIL_PAGE_ROOT + '?copydata=' + encodeURIComponent(username);
                } else {
                    // Standard URL link (Facebook, Instagram, LinkedIn, Mailto)
                    finalUrl = baseUrl + username;
                }
            }
            
            // Update the hidden field that the Python script reads
            finalLinkInput.value = finalUrl;
        }

        // Base URL root for the copy function
        const BASE_DETAIL_PAGE_ROOT = "https://abilash-nickal.github.io/QR-cod-generator/my_detail_moder_UI.html";


        // Initialize link when the page loads if data was previously saved
        window.onload = function() {
            // Function to run on load
            function initialize() {
                // Restore logic for previously selected platform and run updateLink
                updateLink();
            }
            initialize();
        };
        {% endraw %}
    </script>
</body>
</html>
"""

@app.route('/', methods=['GET'])
def index():
    """Renders the main form page."""
    global last_qr_data, saved_input_data
    last_qr_data = None
    saved_input_data = {
        'name': 'Abila',
        'message': 'Check out my profile!',
        'username': 'Your text key here',
        'link': 'https://abilash-nickal.github.io/QR-cod-generator/details.html?copydata=Your%20text%20key%20here',
        'image_url': ''
    }
    return render_template_string(HTML_TEMPLATE, qr_image=None, saved_data=saved_input_data)

@app.route('/generate_qr', methods=['POST'])
def generate_qr():
    """Generates the QR code by encoding the custom target URL."""
    global last_qr_data, saved_input_data
    
    # 1. Capture all form data, including the resolved 'link' from the hidden field
    input_data = {
        'name': request.form.get('name', ''),
        'message': request.form.get('message', ''),
        'link': request.form.get('link', ''), # Full URL is passed here
        'image_url': request.form.get('image_url', ''),
        'username': request.form.get('username_input', '') # Save the raw username for persistence
    }
    saved_input_data = input_data

    # 2. Generate the full target URL with embedded parameters
    encoded_url = generate_target_url(input_data)

    if not encoded_url:
        return render_template_string(HTML_TEMPLATE, qr_image=None, saved_data=saved_input_data, encoded_url="Error: Could not generate URL.", display_url="")

    # 3. Create a user-friendly display URL by unquoting the query parameters
    display_url = urllib.parse.unquote_plus(encoded_url) if encoded_url else ""

    last_qr_data = encoded_url
    
    # 3. Generate the minimized QR code image
    qr = qrcode.QRCode(
        version=1,
        error_correction=QR_ERROR_CORRECTION, 
        box_size=QR_BOX_SIZE,                 
        border=4
    )
    qr.add_data(encoded_url)
    qr.make(fit=True)
    img: PilImage = qr.make_image(fill_color="black", back_color="white")

    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    
    qr_image_base64 = base64.b64encode(buffer.read()).decode('utf-8')
    
    return render_template_string(HTML_TEMPLATE, qr_image=qr_image_base64, encoded_url=encoded_url, display_url=display_url, saved_data=saved_input_data)

@app.route('/download_qr', methods=['GET'])
def download_qr():
    """Serves the generated QR code image for download."""
    global last_qr_data

    if not last_qr_data:
        return "Error: No QR code data found to download.", 404

    qr = qrcode.QRCode(
        version=1,
        error_correction=QR_ERROR_CORRECTION,
        box_size=QR_BOX_SIZE,
        border=4
    )
    qr.add_data(last_qr_data)
    qr.make(fit=True)
    img: PilImage = qr.make_image(fill_color="black", back_color="white")

    download_buffer = io.BytesIO()
    img.save(download_buffer, format="PNG")
    download_buffer.seek(0)
    
    filename_base = saved_input_data.get('name', 'qrcode').replace(' ', '_')
    filename = f"{filename_base}_qr.png"

    return send_file(download_buffer, mimetype='image/png', as_attachment=True, download_name=filename)

if __name__ == '__main__':
    app.run(debug=True, host='127.0.0.1', port=5000)
